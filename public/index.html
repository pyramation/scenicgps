<!DOCTYPE html>
<html>
	<head>
		<title>ScenicGPS</title>
		<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key=ABQIAAAAE7KyQeHRpKeud9rNPtxXFRRn6qXgsAvcFwzl0-YPgC29sEO24BT_h3jOvlteLo8ba3Ud-CWmAhI_dw" type="text/javascript"></script>
		<script src="javascript/jquery-1.5.2.min.js" type="text/javascript"></script>
		<script src="javascript/gps.js" type="text/javascript"></script>
		<script src="javascript/geohash.js" type="text/javascript"></script>

	</head>

	<body>

		<style>
			body {
 				background-color: #F3F3F3;
    				font-family: Verdana, Helvetica, Arial;
    				font-size: 14px;
			}
			.annotationText { font-size: 8pt; font-variant: small-caps; } 
			#map {
				border: 1px solid #979797;
				background-color: #e5e3df; 
				width: 800px;
				height: 800px;
				margin: auto;
				margin-top: 2em;
				margin-bottom: 2em
				-webkit-border-radius: .5em;
				-moz-border-radius: .5em;
  				border-radius: 1em;
				border-style: none;
				border-width: thin;
				border-color: #a8a8a8;
				box-shadow: 6px 6px 6px #bbb;
				-webkit-box-shadow: 6px 6px 6px #bbb;
				-moz-box-shadow: 6px 6px 6px #bbb;
			}
			h2  {
				font-size: 20px;
    				font-weight: 500;
    				line-height: 24px;
    				text-shadow:1px 1px 2px #333333;
			}
			#title{
				width: 750px;
				margin: 0 auto;
        			background-color: #F6F6F6;
				padding: 20px 40px;
				border: solid 1px black;
			        margin-top: 20px;
				-webkit-border-radius: .5em;
				-moz-border-radius: .5em;
  				border-radius: 1em;
				border-style: none;
				border-width: thin;
				border-color: #a8a8a8;
				box-shadow: 2px 2px 2px #bbb;
				-webkit-box-shadow: 2px 2px 2px #bbb;
				-moz-box-shadow: 2px 2px 2px #bbb;
			}
		</style>


		<div id="title"><h1>ScenicGPS</h1></div>

		<div id="map">
			<div style="padding: 1em; color: gray">Loading...</div>
		</div>

		<script type="text/javascript">
			//< ![CDATA[
		var data;
		var geoHashes = [];

		$.ajax({
			url: '/scenic/getallphotos',
			success: function(recv) {
				data = jQuery.parseJSON(recv);
				data = data['response'].photos;
				hashData();
				run();
			}
		});

		function hashData() {
			$.each(data, function(i, c) {
				var geoHash = encodeGeoHash(c.coord.lat, c.coord.lng);
				if (geoHashes[geoHash]) {
					geoHashes[geoHash].push( {title:c.title, image:c.image, lat:c.coord.lat, lng:c.coord.lng, hash:geoHash } );
				} else {
					var gNewArray = new Array();
					gNewArray.push( {title:c.title, image:c.image, lat:c.coord.lat, lng:c.coord.lng, hash:geoHash } );
					geoHashes[geoHash] = gNewArray;
				}
			});	
		}

		function createMarker(point,html) {
			var marker = new GMarker(point);
			GEvent.addListener(marker, "click", function() {
				marker.openInfoWindowHtml(html);
			});
			return marker;
		}

		function getExtension(filename) {
    			return filename.split('.').pop().toLowerCase();
		}		

		function displayContent(obj) { 
			var str = '<span class="annotationText">'+obj.title+'</span><br><a href="'+ obj.image + '" target="blank">';
			var src = (getExtension(obj.image) ==='mov') ? "images/video.png"  : obj.image;
			str += '<img width="50px" height="50px" src="'+ src + '"></a>';
			return str;
		}
		function run() {

			if (GBrowserIsCompatible()) {

				var map = new GMap2(document.getElementById("map"));
				map.addControl(new GLargeMapControl());
				map.addControl(new GMapTypeControl());
				map.setCenter(new GLatLng(37.8715926,-122.2727470), 14);

				for(x in geoHashes) {
					var content;
					var point;
					content = '<div style="width: 300px; height: 200px; overflow-y:scroll;">';
					$.each(geoHashes[x], function(i,y) {
						point = new GLatLng( y.lat,y.lng);
						content += displayContent(y) + "<br>";
					});
					content += '</div>';
					var marker = createMarker(point,content);
					map.addOverlay(marker); 
				}
			}		
		}

//]]>
</script>

		  </body>
	  </html>
